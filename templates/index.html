<!DOCTYPE html>

<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Intense Experience - Réservation</title>

        <!-- Font Awesome for icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- Vue.js -->
        <script src="https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.global.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue3-sfc-loader/dist/vue3-sfc-loader.js"></script>
    </head>
    <body>

        <div id="app">
            <main class="main-content">
                <!-- General Booking Access Point -->
                <section id="booking" class="booking-section">
                    <div class="container">

                        <!-- Booking Widget -->
                        <booking-widget
                            access-point="general"
                            :preselected-suite-id="suiteId"
                            :preselected-service-id="serviceId"
                            @service-selected="handleServiceSelection"
                        ></booking-widget>
                    </div>
                </section>
            </main>
        </div>

        <script>
        const options = {
            moduleCache: {
                vue: Vue
            },
            async getFile(url) {
                const res = await fetch(url);
                if (!res.ok)
                    throw Object.assign(new Error(res.statusText + ' ' + url), { res });
                return {
                    getContentData: asBinary => asBinary ? res.arrayBuffer() : res.text(),
                }
            },
            addStyle(textContent) {
                const style = Object.assign(document.createElement('style'), { textContent });
                const ref = document.head.getElementsByTagName('style')[0] || null;
                document.head.insertBefore(style, ref);
            },
        }

        const { loadModule } = window['vue3-sfc-loader'];

        // Make options and loadModule globally available for components
        window.vueOptions = options;
        window.vueLoadModule = loadModule;

        const app = Vue.createApp({
            data() {
                return {
                    featuredSuites: [],
                    nightServiceId: '7ba0b732-93cc-477a-861d-b3850108b730', // NUITEE service ID
                    loading: true,
                    error: null,
                    // URL parameters from Flask
                    suiteId: '{{ suite_id or "" }}',
                    serviceId: '{{ service_id or "" }}',
                    // Background theme based on selected service
                    selectedServiceType: null // 'journée' or 'nuitée'
                }
            },
            watch: {
                selectedServiceType(newType) {
                    this.updateBackgroundColors(newType)
                }
            },
            async mounted() {
                await this.loadSuites();
            },
            methods: {
                handleServiceSelection(eventData) {
                    this.selectedServiceType = eventData.serviceType
                },

                updateBackgroundColors(serviceType) {
                    const root = document.documentElement

                    if (serviceType === 'nuitée') {
                        // Dark theme - light text
                        root.style.setProperty('--app-background', '#0B0B0B')
                        root.style.setProperty('--booking-section-background', '#0B0B0B')
                        root.style.setProperty('--suites-showcase-background', '#0B0B0B')
                        root.style.setProperty('--primary-text-color', '#ffffff')
                        root.style.setProperty('--secondary-text-color', '#cccccc')
                        root.style.setProperty('--heading-text-color', '#ffffff')
                    } else if (serviceType === 'journée') {
                        // Light theme - dark text
                        root.style.setProperty('--app-background', '#E5E5DB')
                        root.style.setProperty('--booking-section-background', '#E5E5DB')
                        root.style.setProperty('--suites-showcase-background', '#E5E5DB')
                        root.style.setProperty('--primary-text-color', '#333333')
                        root.style.setProperty('--secondary-text-color', '#666666')
                        root.style.setProperty('--heading-text-color', '#333333')
                    } else {
                        // Default/reset - light background, dark text
                        root.style.setProperty('--app-background', '#f8f9fa')
                        root.style.setProperty('--booking-section-background', '#ffffff')
                        root.style.setProperty('--suites-showcase-background', '#f8f9fa')
                        root.style.setProperty('--primary-text-color', '#333333')
                        root.style.setProperty('--secondary-text-color', '#666666')
                        root.style.setProperty('--heading-text-color', '#333333')
                    }
                },

                async loadSuites() {
                    try {
                        this.loading = true;
                        const response = await fetch(`/intense_experience-api/suites?service_id=${this.nightServiceId}`);
                        const data = await response.json();
                        
                        if (data.status === 'success' && data.suites) {
                            // Map API data to our frontend format
                            this.featuredSuites = data.suites
                                .filter(suite => suite.Type === 'Suite') // Only show suites, not rooms or spaces
                                .map(suite => {
                                    const name = suite.Names['fr-FR'] || suite.Names[Object.keys(suite.Names)[0]] || suite.Name;
                                    const description = suite.Descriptions['fr-FR'] || suite.Descriptions[Object.keys(suite.Descriptions)[0]] || '';
                                    
                                    // Map suite names to image filenames
                                    const suiteImageMap = {
                                        'Suite GAIA': 'suite-gaia.jpg',
                                        'Suite EXTASE': 'suite-extase.jpg',
                                        'Suite INTENSE': 'suite-intense.jpg'
                                    };
                                    
                                    return {
                                        id: suite.Id,
                                        name: name,
                                        description: description,
                                        capacity: suite.Capacity,
                                        extraCapacity: suite.ExtraCapacity,
                                        image: `/static/images/${suiteImageMap[name] || 'suite-default.jpg'}`,
                                        ordering: suite.Ordering
                                    };
                                })
                                .sort((a, b) => a.ordering - b.ordering); // Sort by ordering
                            
                            this.loading = false;
                        } else {
                            throw new Error(data.error || 'Failed to load suites');
                        }
                    } catch (error) {
                        console.error('Error loading suites:', error);
                        this.error = 'Impossible de charger les suites. Veuillez réessayer plus tard.';
                        this.loading = false;
                    }
                }
            },
            components: {
                'booking-widget': Vue.defineAsyncComponent(() => loadModule('/static/vue/BookingWidget.vue', options)),
            }
        });
        app.mount('#app');
        </script>
    </body>

</html>